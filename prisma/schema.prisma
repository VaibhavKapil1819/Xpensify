// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  //output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ------------------------------------
// Models
// ------------------------------------

model Profile {
  id                  String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email               String              @unique
  password_hash       String
  full_name           String?
  primary_goal        String?
  risk_level          RiskLevel?
  learning_preference LearningPreference?
  currency            String              @default("USD")
  created_at          DateTime            @default(now()) @db.Timestamptz(6)
  updated_at          DateTime            @default(now()) @db.Timestamptz(6)

  // Relations
  goals             Goal[]
  learning_progress LearningProgress[]
  user_streak       UserStreak?
  ai_conversations  AIConversation[]
  transactions      Transaction[]

  @@map("profiles")
}

model Goal {
  id                        String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                   String     @db.Uuid
  title                     String
  description               String?
  target_amount             Decimal?   @db.Decimal(12, 2)
  current_amount            Decimal    @default(0) @db.Decimal(12, 2)
  target_date               DateTime?  @db.Date
  category                  String?
  status                    GoalStatus @default(active)
  ai_completion_probability Decimal?   @db.Decimal(5, 2)
  created_at                DateTime   @default(now()) @db.Timestamptz(6)
  updated_at                DateTime   @default(now()) @db.Timestamptz(6)

  // Relations
  profile    Profile     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  milestones Milestone[]

  @@map("goals")
}

model Milestone {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  goal_id       String    @db.Uuid
  title         String
  description   String?
  target_amount Decimal?  @db.Decimal(12, 2)
  completed     Boolean   @default(false)
  due_date      DateTime? @db.Date
  completed_at  DateTime? @db.Timestamptz(6)
  created_at    DateTime  @default(now()) @db.Timestamptz(6)

  // Relations
  goal Goal @relation(fields: [goal_id], references: [id], onDelete: Cascade)

  @@map("milestones")
}

model LearningProgress {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String    @db.Uuid
  lesson_id    String
  lesson_title String
  category     String?
  completed    Boolean   @default(false)
  score        Decimal?  @db.Decimal(5, 2)
  completed_at DateTime? @db.Timestamptz(6)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)

  // Relations
  profile Profile @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, lesson_id])
  @@map("learning_progress")
}

model UserStreak {
  id                      String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                 String    @unique @db.Uuid
  current_streak          Int       @default(0)
  longest_streak          Int       @default(0)
  last_activity_date      DateTime? @db.Date
  total_lessons_completed Int       @default(0)
  badges                  Json      @default("[]")
  created_at              DateTime  @default(now()) @db.Timestamptz(6)
  updated_at              DateTime  @default(now()) @db.Timestamptz(6)

  profile Profile @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_streaks")
}

model AIConversation {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  agent_type AgentType
  message    String
  role       RoleType
  created_at DateTime  @default(now()) @db.Timestamptz(6)

  profile Profile @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("ai_conversations")
}

model Transaction {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String          @db.Uuid
  amount      Decimal         @db.Decimal(12, 2)
  type        TransactionType
  category    String
  description String?
  date        DateTime        @db.Date
  created_at  DateTime        @default(now()) @db.Timestamptz(6)

  profile Profile @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("transactions")
}

// ------------------------------------
// Enums
// ------------------------------------

enum RiskLevel {
  conservative
  moderate
  aggressive
}

enum LearningPreference {
  visual
  text
  interactive
  mixed
}

enum GoalStatus {
  active
  completed
  paused
  cancelled
}

enum AgentType {
  finley
  ava
}

enum RoleType {
  user
  assistant
}

enum TransactionType {
  income
  expense
}
